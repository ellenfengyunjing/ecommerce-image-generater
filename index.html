<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ç”µå•†å›¾ç‰‡è‡ªåŠ¨å¥—ç‰ˆç”Ÿæˆå·¥å…·ï¼ˆçº¯ HTML + JSï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #111827;
      --card: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.1);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --danger: #f97373;
      --radius-lg: 16px;
      --radius-md: 10px;
      --radius-sm: 6px;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 50%, #020617 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 24px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .app {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      background: radial-gradient(circle at top left, rgba(56,189,248,0.12), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(129,140,248,0.15), transparent 55%),
                  rgba(15,23,42,0.96);
      border-radius: 24px;
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow:
        0 40px 80px rgba(15,23,42,0.85),
        0 0 0 1px rgba(15,23,42,0.9);
      padding: 28px 28px 24px;
      backdrop-filter: blur(20px);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 24px;
    }
    .title-block {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .title-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .badge {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.4);
      background: rgba(15,23,42,0.9);
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34,197,94,0.2);
    }
    h1 {
      font-size: 22px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    h1 span.emoji {
      font-size: 22px;
    }
    .subtitle {
      font-size: 13px;
      color: var(--muted);
    }
    .tips {
      font-size: 12px;
      color: var(--muted);
      text-align: right;
      max-width: 260px;
      line-height: 1.5;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 20px;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.4), rgba(15,23,42,0.9));
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 18px 16px 14px;
      box-shadow:
        0 18px 45px rgba(15,23,42,0.8),
        0 0 0 1px rgba(15,23,42,0.9);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .card-title {
      font-size: 15px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-title span.icon {
      font-size: 18px;
    }
    .card-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .field {
      margin-bottom: 12px;
    }
    .field-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .field-label span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .field-label small {
      font-size: 11px;
      color: #6b7280;
    }

    .file-input {
      padding: 10px 10px;
      border-radius: var(--radius-md);
      border: 1px dashed rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.8);
      color: var(--muted);
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .file-input input[type="file"] {
      font-size: 12px;
      color: var(--text);
    }
    .file-hint {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    textarea {
      width: 100%;
      min-height: 90px;
      max-height: 160px;
      resize: vertical;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      padding: 10px 11px;
      font-size: 13px;
      line-height: 1.5;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    textarea::placeholder {
      color: #6b7280;
    }
    textarea:focus {
      border-color: rgba(56,189,248,0.9);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.6);
      background: #020617;
    }
    select {
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    select:focus {
      border-color: rgba(56,189,248,0.9);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.6);
      background: #020617;
      outline: none;
    }

    .actions-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-top: 6px;
    }
    .generate-btn {
      border: none;
      border-radius: 999px;
      padding: 9px 18px;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      background: radial-gradient(circle at top left, #38bdf8, #0ea5e9);
      color: white;
      box-shadow:
        0 0 0 1px rgba(56,189,248,0.3),
        0 16px 30px rgba(56,189,248,0.4);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
      white-space: nowrap;
    }
    .generate-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(56,189,248,0.4),
        0 20px 45px rgba(56,189,248,0.55);
      filter: brightness(1.05);
    }
    .generate-btn:active:not(:disabled) {
      transform: translateY(0);
      box-shadow:
        0 0 0 1px rgba(56,189,248,0.4),
        0 10px 22px rgba(56,189,248,0.45);
      filter: brightness(0.98);
    }
    .generate-btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow:
        0 0 0 1px rgba(148,163,184,0.4),
        0 8px 16px rgba(15,23,42,0.6);
      background: linear-gradient(90deg, #4b5563, #6b7280);
    }
    .generate-btn span.icon {
      font-size: 16px;
    }

    .status {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #38bdf8;
      box-shadow: 0 0 0 4px rgba(56,189,248,0.25);
      animation: pulse 1.2s infinite ease-out;
    }
    .status.error {
      color: var(--danger);
    }
    .status.error .status-dot {
      background: var(--danger);
      box-shadow: 0 0 0 4px rgba(248,113,113,0.25);
      animation: none;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.8); opacity: 0; }
    }

    .gallery-info {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
    }
    .image-card {
      background: linear-gradient(180deg, rgba(15,23,42,0.6), rgba(15,23,42,0.95));
      border-radius: var(--radius-md);
      border: 1px solid rgba(31,41,55,0.95);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow:
        0 12px 22px rgba(15,23,42,0.9),
        0 0 0 1px rgba(15,23,42,0.9);
    }
    .image-wrapper {
      position: relative;
      background: radial-gradient(circle at top, #111827, #020617);
      aspect-ratio: 4 / 5;
      overflow: hidden;
    }
    .image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 0.3s ease;
    }
    .image-card:hover img {
      transform: scale(1.02);
    }
    .image-meta {
      padding: 8px 9px 7px;
      border-top: 1px solid rgba(31,41,55,0.9);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .image-meta-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .image-title {
      font-size: 12px;
      color: #e5e7eb;
    }
    .image-subtitle {
      font-size: 11px;
      color: #6b7280;
    }
    .download-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 11px;
      padding: 4px 9px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.1s ease;
    }
    .download-btn:hover {
      background: rgba(31,41,55,1);
      border-color: rgba(209,213,219,0.9);
      transform: translateY(-0.5px);
    }
    .download-btn span.icon {
      font-size: 13px;
    }

    .footer-note {
      margin-top: 14px;
      font-size: 11px;
      color: #6b7280;
      text-align: right;
    }

    @media (max-width: 900px) {
      body {
        padding: 16px;
      }
      .app {
        padding: 18px 16px 18px;
      }
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      .tips {
        text-align: left;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="title-block">
      <div class="title-row">
        <h1><span class="emoji">ğŸ¨</span> ç”µå•†å›¾ç‰‡è‡ªåŠ¨å¥—ç‰ˆç”Ÿæˆå·¥å…·</h1>
        <div class="badge">
          <span class="badge-dot"></span>
          <span>å³æ¢¦å›¾åƒç”Ÿæˆ Â· åç«¯æœåŠ¡</span>
        </div>
      </div>
      <div class="subtitle">
        ä¸Šä¼ å‚è€ƒå›¾ + äº§å“å›¾ + å–ç‚¹æ–‡æ¡ˆï¼Œä¸€é”®ç”Ÿæˆå¤šå¼ åŒé£æ ¼ç”µå•†å›¾ï¼Œæ”¯æŒæ‰¹é‡ä¸‹è½½ã€‚
      </div>
    </div>
    <div class="tips">
      ä½¿ç”¨ <b>å³æ¢¦å›¾åƒç”Ÿæˆ</b> æœåŠ¡ã€‚<br />
      éœ€è¦å…ˆå¯åŠ¨åç«¯æœåŠ¡å™¨ï¼š<code>python server.py</code><br />
      <span style="color: #fbbf24; font-weight: 500;">âš ï¸ è¯·ç¡®ä¿åç«¯æœåŠ¡å·²è¿è¡Œåœ¨ http://localhost:8000</span>
    </div>
  </div>

  <div class="layout">
    <!-- å·¦ä¾§ï¼šè¾“å…¥åŒº -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">
            <span class="icon">ğŸ“¤</span>
            ä¸Šä¼ ç´ æ & æ–‡æ¡ˆ
          </div>
          <div class="card-subtitle">å‚è€ƒå›¾æ”¯æŒå¤šå¼ ï¼Œäº§å“å›¾å•å¼ ï¼Œå–ç‚¹æ–‡æ¡ˆä¼šè‡ªåŠ¨æ’ç‰ˆåˆ°ç”»é¢ä¸­ã€‚</div>
        </div>
      </div>

      <div class="field">
        <div class="field-label">
          <span>å‚è€ƒå›¾ï¼ˆæ”¯æŒå¤šå¼ ï¼‰</span>
          <small>æ¯å¼ å‚è€ƒå›¾ä¼šç”Ÿæˆä¸€å¼ ç»“æœå›¾</small>
        </div>
        <div class="file-input">
          <input id="refImages" type="file" accept="image/*" multiple />
        </div>
        <div class="file-hint">å»ºè®®ä¸Šä¼ ä½ å–œæ¬¢çš„ç”µå•†å¹¿å‘Šå›¾ï¼Œç”¨æ¥"å¥—ç‰ˆ"é£æ ¼å’Œæ’ç‰ˆã€‚</div>
      </div>

      <div class="field">
        <div class="field-label">
          <span>äº§å“å›¾ï¼ˆå•å¼ ï¼‰</span>
          <small>æ¨èç™½åº•æˆ–é€æ˜åº• PNG</small>
        </div>
        <div class="file-input">
          <input id="productImage" type="file" accept="image/*" />
        </div>
        <div class="file-hint">å»ºè®®ä½¿ç”¨é«˜åˆ†è¾¨ç‡äº§å“å›¾ï¼ŒèƒŒæ™¯è¶Šå¹²å‡€ï¼Œæ•ˆæœè¶Šå¥½ã€‚</div>
      </div>

      <div class="field">
        <div class="field-label">
          <span>å–ç‚¹æ–‡æ¡ˆï¼ˆå¯é€‰ï¼‰</span>
          <small>ç•™ç©ºåˆ™ä¿æŒå‚è€ƒå›¾åŸæœ‰æ–‡æ¡ˆ</small>
        </div>
        <textarea id="sellingPoints" placeholder="ç¤ºä¾‹ï¼šé™æ—¶ç‰¹ä»· / ä¹°ä¸€é€ä¸€ / æ­£å“ä¿éšœ / ä¸ƒå¤©æ— ç†ç”±é€€æ¢...ï¼ˆç•™ç©ºåˆ™ä¿æŒå‚è€ƒå›¾åŸæœ‰æ–‡æ¡ˆï¼‰"></textarea>
      </div>

      <div class="field">
        <div class="field-label">
          <span>å›¾ç‰‡å°ºå¯¸</span>
          <small>é€‰æ‹©ç”Ÿæˆå›¾ç‰‡çš„å°ºå¯¸</small>
        </div>
        <select id="imageSize" style="width: 100%; padding: 10px 11px; border-radius: var(--radius-md); border: 1px solid rgba(148,163,184,0.5); background: rgba(15,23,42,0.9); color: var(--text); font-size: 13px; outline: none;">
          <option value="1K">1K (1024x1024)</option>
          <option value="2K" selected>2K (2048x2048)</option>
          <option value="4K">4K (4096x4096)</option>
        </select>
      </div>

      <div class="field">
        <div class="field-label">
          <span>æ¸…æ™°åº¦</span>
          <small>é€‰æ‹©ç”Ÿæˆå›¾ç‰‡çš„æ¸…æ™°åº¦çº§åˆ«</small>
        </div>
        <select id="imageQuality" style="width: 100%; padding: 10px 11px; border-radius: var(--radius-md); border: 1px solid rgba(148,163,184,0.5); background: rgba(15,23,42,0.9); color: var(--text); font-size: 13px; outline: none;">
          <option value="standard">æ ‡å‡†</option>
          <option value="high" selected>é«˜æ¸…</option>
          <option value="ultra">è¶…é«˜æ¸…</option>
        </select>
      </div>

      <div class="actions-row">
        <button id="generateBtn" class="generate-btn">
          <span class="icon">ğŸš€</span>
          <span>ç”Ÿæˆå›¾ç‰‡</span>
        </button>
        <div id="status" class="status">
          <span class="status-dot"></span>
          <span>ç­‰å¾…ç”Ÿæˆ...</span>
        </div>
      </div>
    </div>

    <!-- å³ä¾§ï¼šç»“æœåŒº -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">
            <span class="icon">ğŸ¯</span>
            ç”Ÿæˆç»“æœ
          </div>
          <div class="card-subtitle">æ¯å¼ å‚è€ƒå›¾ä¼šå¯¹åº”ç”Ÿæˆä¸€å¼ æ–°çš„ç”µå•†å›¾ç‰‡ï¼Œæ”¯æŒå•å¼ ä¸‹è½½ã€‚</div>
        </div>
      </div>

      <div class="gallery-info">
        <div id="resultInfo">å°šæœªç”Ÿæˆå›¾ç‰‡</div>
        <div style="font-size: 11px; color: #6b7280;">
          æç¤ºï¼šç”Ÿæˆè¿‡ç¨‹ä¾èµ–ç½‘ç»œå’Œ APIï¼Œå¯èƒ½éœ€è¦å‡ ç§’åˆ°å‡ åç§’ã€‚
        </div>
      </div>

      <div id="gallery" class="gallery-grid"></div>

      <div class="footer-note">
        åç«¯æœåŠ¡è´Ÿè´£è°ƒç”¨å³æ¢¦ APIï¼ŒAPI Key å®‰å…¨ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ã€‚<br />
        <span style="color: #f97373; font-weight: 500;">âš ï¸ é‡è¦ï¼šè¯·ç¡®ä¿åç«¯æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œå¹¶åœ¨ server.py ä¸­é…ç½®ç«å±±å¼•æ“å‡­è¯</span>
      </div>
    </div>
  </div>
</div>

<script>
  /***********************
   * é…ç½®ï¼šåç«¯ API åœ°å€ *
   **********************/
  // åç«¯æœåŠ¡å™¨åœ°å€ï¼ˆå³æ¢¦å›¾åƒç”ŸæˆæœåŠ¡ï¼‰
  // æœ¬åœ°å¼€å‘ï¼šhttp://localhost:8000/api/generate
  // ç”Ÿäº§ç¯å¢ƒï¼šè¯·ä¿®æ”¹ä¸ºå®é™…çš„åç«¯æœåŠ¡å™¨åœ°å€
  // å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶è®¾ç½®ï¼Œé¿å…ç¡¬ç¼–ç 
  const BACKEND_API_URL = (() => {
    // ä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆå¦‚æœéƒ¨ç½²åˆ°æ”¯æŒç¯å¢ƒå˜é‡çš„å¹³å°ï¼‰
    if (typeof process !== 'undefined' && process.env && process.env.REACT_APP_API_URL) {
      return process.env.REACT_APP_API_URL;
    }
    // æ£€æŸ¥æ˜¯å¦æœ‰å…¨å±€é…ç½®
    if (typeof window !== 'undefined' && window.APP_CONFIG && window.APP_CONFIG.API_URL) {
      return window.APP_CONFIG.API_URL;
    }
    // é»˜è®¤ä½¿ç”¨æœ¬åœ°å¼€å‘åœ°å€
    return "http://localhost:8000/api/generate";
  })();

  /******************
   * å·¥å…·å‡½æ•° *
   ******************/
  function setStatus(text, type = "normal") {
    const statusEl = document.getElementById("status");
    const span = statusEl.querySelector("span:nth-child(2)");
    span.textContent = text;

    if (type === "error") {
      statusEl.classList.add("error");
    } else {
      statusEl.classList.remove("error");
    }
  }

  function setResultInfo(text) {
    const infoEl = document.getElementById("resultInfo");
    infoEl.textContent = text;
  }

  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = e => reject(e);
      reader.readAsDataURL(file);
    });
  }

  function dataUrlToBase64(dataUrl) {
    const parts = dataUrl.split(",");
    return parts[1] || "";
  }

  function base64ToBlobUrl(base64, mimeType = "image/png") {
    const byteCharacters = atob(base64);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
      byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    const blob = new Blob([byteArray], { type: mimeType });
    return URL.createObjectURL(blob);
  }

  function appendImageCard(base64, index) {
    const gallery = document.getElementById("gallery");
    const card = document.createElement("div");
    card.className = "image-card";

    const wrapper = document.createElement("div");
    wrapper.className = "image-wrapper";

    const img = document.createElement("img");
    img.src = "data:image/png;base64," + base64;

    wrapper.appendChild(img);

    const meta = document.createElement("div");
    meta.className = "image-meta";

    const left = document.createElement("div");
    left.className = "image-meta-left";

    const title = document.createElement("div");
    title.className = "image-title";
    title.textContent = "ç”Ÿæˆå›¾ç‰‡ #" + (index + 1);

    const subtitle = document.createElement("div");
    subtitle.className = "image-subtitle";
    subtitle.textContent = "ç‚¹å‡»ä¸‹è½½æŒ‰é’®ä¿å­˜åˆ°æœ¬åœ°";

    left.appendChild(title);
    left.appendChild(subtitle);

    const btn = document.createElement("button");
    btn.className = "download-btn";
    btn.innerHTML = '<span class="icon">â¬‡ï¸</span><span>ä¸‹è½½</span>';

    btn.addEventListener("click", () => {
      const url = base64ToBlobUrl(base64, "image/png");
      const a = document.createElement("a");
      a.href = url;
      a.download = "generated_image_" + (index + 1) + ".png";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    meta.appendChild(left);
    meta.appendChild(btn);

    card.appendChild(wrapper);
    card.appendChild(meta);

    gallery.appendChild(card);
  }

  /**********************
   * Prompt æ„å»ºé€»è¾‘   *
   *********************/
  function buildPrompt(referenceStyleDesc, sellingPoints) {
    return `
è¯·åˆ†æç”¨æˆ·æä¾›çš„ç”µå•†å‚è€ƒå›¾çš„é£æ ¼å’Œæ’ç‰ˆï¼Œå¹¶åŸºäºæ­¤ç”Ÿæˆä¸€å¼ æ–°çš„ç”µå•†å®£ä¼ å›¾ã€‚

è¦æ±‚ï¼š
1. å……åˆ†å‚è€ƒå‚è€ƒå›¾åœ¨é£æ ¼ã€æ„å›¾ã€è‰²è°ƒã€å…‰å½±ã€ç‰ˆå¼ä¸Šçš„ç‰¹å¾ï¼š${referenceStyleDesc}
2. ä¿æŒæ•´ä½“è§†è§‰é£æ ¼å’Œæ’ç‰ˆé€»è¾‘åŸºæœ¬ä¸€è‡´ï¼Œä½†å…è®¸åœ¨ç»†èŠ‚ä¸Šæœ‰ä¸€å®šåˆ›æ„è°ƒæ•´
3. å‚è€ƒå›¾ä¸­çš„åŸäº§å“ï¼Œè¯·å®Œå…¨æ›¿æ¢ä¸ºç”¨æˆ·æä¾›çš„äº§å“å›¾ï¼Œä¿æŒäº§å“å½¢çŠ¶ã€æ¯”ä¾‹å’Œè´¨æ„ŸçœŸå®
4. ç”»é¢ä¸­çš„æ‰€æœ‰æ–‡æ¡ˆå†…å®¹ï¼Œè¯·å…¨éƒ¨æ›¿æ¢ä¸ºä»¥ä¸‹å–ç‚¹æ–‡æ¡ˆï¼š
   ã€Œ${sellingPoints}ã€
5. æ–°ç”Ÿæˆå›¾ç‰‡è¦é€‚åˆç”¨äºç”µå•†ä¸»å›¾æˆ–æ´»åŠ¨æµ·æŠ¥ï¼Œè§†è§‰å†²å‡»åŠ›å¼ºï¼Œç»“æ„æ¸…æ™°ï¼Œå¯è¯»æ€§å¥½
6. å›¾ç‰‡ä¸­ä¸è¦å‡ºç°ä¸åŸå“ç‰Œç›¸å…³çš„æ–‡å­—æˆ– Logoï¼Œä¸“æ³¨äºç”¨æˆ·çš„äº§å“å’Œæ–‡æ¡ˆ

è¯·è¾“å‡ºä¸€å¼ é«˜è´¨é‡ã€é€‚åˆç”µå•†ä½¿ç”¨çš„äº§å“å®£ä¼ å›¾ç‰‡ã€‚
    `.trim();
  }

  async function analyzeReferenceStyle(file) {
    const nameHint = file.name ? `æ–‡ä»¶åï¼š${file.name}` : "";
    return `ç”µå•†å¹¿å‘Šé£æ ¼ï¼Œå¸ƒå±€ç´§å‡‘ï¼Œä¸»ä½“äº§å“çªå‡ºï¼ŒèƒŒæ™¯å…·æœ‰ä¸€å®šçš„è£…é¥°å…ƒç´ ã€‚${nameHint}`;
  }

  /**********************
   * è°ƒç”¨åç«¯ APIï¼ˆå³æ¢¦ï¼‰*
   *********************/
  async function callBackendAPI(referenceImagesBase64, productImageBase64, sellingPoints, imageSize, imageQuality) {
    try {
      const payload = {
        reference_images: referenceImagesBase64,
        product_image: productImageBase64,
        selling_points: sellingPoints || "",  // å…è®¸ä¸ºç©º
        image_size: imageSize,
        image_quality: imageQuality
      };

      const resp = await fetch(BACKEND_API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        let errorData;
        try {
          errorData = await resp.json();
        } catch (e) {
          const text = await resp.text();
          errorData = { error: text };
        }
        throw new Error(errorData.error || errorData.message || `HTTP ${resp.status}`);
      }

      const data = await resp.json();
      
      if (!data.success) {
        throw new Error(data.error || "åç«¯è¿”å›é”™è¯¯");
      }

      return data;
    } catch (error) {
      // å¤„ç†ç½‘ç»œé”™è¯¯
      if (error.name === "TypeError" && error.message.includes("Failed to fetch")) {
        throw new Error(
          `âŒ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨ï¼\n\n` +
          `è¯·ç¡®ä¿ï¼š\n` +
          `1. åç«¯æœåŠ¡å™¨å·²å¯åŠ¨ï¼ˆè¿è¡Œï¼špython server.pyï¼‰\n` +
          `2. åç«¯è¿è¡Œåœ¨ http://localhost:8000\n` +
          `3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®\n\n` +
          `åŸå§‹é”™è¯¯ï¼š${error.message}`
        );
      }
      throw error;
    }
  }

  /**********************
   * ä¸»æµç¨‹ï¼šç”Ÿæˆå›¾ç‰‡   *
   *********************/
  document.getElementById("generateBtn").addEventListener("click", async () => {
    const refInput = document.getElementById("refImages");
    const prodInput = document.getElementById("productImage");
    const textInput = document.getElementById("sellingPoints");
    const gallery = document.getElementById("gallery");
    const btn = document.getElementById("generateBtn");

    const refFiles = Array.from(refInput.files || []);
    const prodFile = prodInput.files && prodInput.files[0];
    const sellingPoints = (textInput.value || "").trim();

    if (!refFiles.length) {
      setStatus("è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ å‚è€ƒå›¾ã€‚", "error");
      return;
    }
    if (!prodFile) {
      setStatus("è¯·ä¸Šä¼ ä¸€å¼ äº§å“å›¾ã€‚", "error");
      return;
    }
    
    // è·å–å°ºå¯¸å’Œæ¸…æ™°åº¦é€‰é¡¹
    const imageSize = document.getElementById("imageSize").value;
    const imageQuality = document.getElementById("imageQuality").value;

    setStatus(`æ­£åœ¨è¯»å–å›¾ç‰‡æ–‡ä»¶...`, "normal");
    setResultInfo("æ­£åœ¨å‡†å¤‡ç”Ÿæˆï¼Œè¯·ç¨å€™...");
    gallery.innerHTML = "";
    btn.disabled = true;

    try {
      setStatus("æ­£åœ¨è¯»å–å›¾ç‰‡æ–‡ä»¶...", "normal");
      
      // è¯»å–æ‰€æœ‰å‚è€ƒå›¾
      const referenceImagesBase64 = [];
      for (const refFile of refFiles) {
        const refDataUrl = await readFileAsDataURL(refFile);
        const refBase64 = dataUrlToBase64(refDataUrl);
        referenceImagesBase64.push(refBase64);
      }
      
      // è¯»å–äº§å“å›¾
      const prodDataUrl = await readFileAsDataURL(prodFile);
      const prodBase64 = dataUrlToBase64(prodDataUrl);

      setStatus(`æ­£åœ¨è°ƒç”¨åç«¯ API ç”Ÿæˆå›¾ç‰‡ï¼ˆå…± ${refFiles.length} å¼ å‚è€ƒå›¾ï¼‰...`, "normal");

      // è°ƒç”¨åç«¯ APIï¼ˆä¸€æ¬¡æ€§å‘é€æ‰€æœ‰å‚è€ƒå›¾ï¼‰
      const result = await callBackendAPI(referenceImagesBase64, prodBase64, sellingPoints, imageSize, imageQuality);

      // å¤„ç†ç»“æœ
      const total = result.total || refFiles.length;
      let successCount = 0;

      for (let i = 0; i < result.results.length; i++) {
        const item = result.results[i];
        if (item.success && item.image_base64) {
          appendImageCard(item.image_base64, item.index !== undefined ? item.index : i);
          successCount++;
        } else {
          console.error(`ç¬¬ ${i + 1} å¼ å›¾ç‰‡ç”Ÿæˆå¤±è´¥:`, item.error);
          setStatus(`ç¬¬ ${i + 1} å¼ å‚è€ƒå›¾ç”Ÿæˆå¤±è´¥ï¼š${item.error || "æœªçŸ¥é”™è¯¯"}`, "error");
        }
      }

      if (successCount > 0) {
        setResultInfo(`ç”Ÿæˆå®Œæˆï¼šæˆåŠŸ ${successCount} å¼  / å…± ${total} å¼ ã€‚`);
        setStatus("ç”Ÿæˆå®Œæˆï¼Œå¦‚éœ€é‡æ–°ç”Ÿæˆå¯ä¿®æ”¹ç´ æåå†æ¬¡ç‚¹å‡»ã€‚");
      } else {
        setResultInfo("æœªæˆåŠŸç”Ÿæˆä»»ä½•å›¾ç‰‡ï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®å’Œç½‘ç»œæƒ…å†µã€‚");
        setStatus("å…¨éƒ¨ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡å™¨æ—¥å¿—ã€‚", "error");
      }
    } catch (err) {
      console.error(err);
      setStatus("ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š" + err.message, "error");
      setResultInfo("ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯æç¤ºã€‚");
    } finally {
      btn.disabled = false;
    }
  });
</script>
</body>
</html>
